# Makefile for Auth-Supabase Project
# ä½¿ç”¨æ–¹æ³•: make <target>

.PHONY: help install dev test lint format type-check security clean build docker run

# é»˜è®¤ç›®æ ‡
help:
	@echo "å¯ç”¨çš„å‘½ä»¤:"
	@echo "  install     - å®‰è£…é¡¹ç›®ä¾èµ–"
	@echo "  dev         - å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  test        - è¿è¡Œæµ‹è¯•"
	@echo "  test-cov    - è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  lint        - ä»£ç æ£€æŸ¥ (ruff)"
	@echo "  format      - ä»£ç æ ¼å¼åŒ– (ruff)"
	@echo "  type-check  - ç±»å‹æ£€æŸ¥ (mypy)"
	@echo "  security    - å®‰å…¨æ‰«æ (bandit + pip-audit)"
	@echo "  pre-commit  - è¿è¡Œpre-commitæ£€æŸ¥"
	@echo "  clean       - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  build       - æ„å»ºPythonåŒ…"
	@echo "  docker      - æ„å»ºDockeré•œåƒ"
	@echo "  run         - å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo "  run-prod    - å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨"

# å®‰è£…ä¾èµ–
install:
	pip install --upgrade pip
	pip install -r requirements.txt

# å®‰è£…å¼€å‘ä¾èµ–
dev: install
	pip install pytest pytest-asyncio pytest-cov pytest-mock httpx
	pip install ruff mypy bandit pip-audit pre-commit
	pre-commit install

# è¿è¡Œæµ‹è¯•
test:
	pytest tests/ -v

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-cov:
	pytest tests/ --cov=app --cov-report=term-missing --cov-report=html:htmlcov --cov-report=xml:coverage.xml --cov-fail-under=80 -v

# ä»£ç æ£€æŸ¥
lint:
	ruff check app/ tests/

# ä»£ç æ ¼å¼åŒ–
format:
	ruff format app/ tests/
	ruff check app/ tests/ --fix

# ç±»å‹æ£€æŸ¥
type-check:
	mypy app/ --config-file pyproject.toml

# å®‰å…¨æ‰«æ
security:
	bandit -r app/ -f txt
	pip-audit

# è¿è¡Œæ‰€æœ‰æ£€æŸ¥
check: lint type-check security

# è¿è¡Œpre-commit
pre-commit:
	pre-commit run --all-files

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf build/
	rm -rf dist/
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf coverage.xml
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/
	rm -rf .ruff_cache/

# æ„å»ºPythonåŒ…
build: clean
	pip install build
	python -m build

# æ„å»ºDockeré•œåƒ
docker:
	docker build -t auth-supabase:latest .

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
run:
	uvicorn app.main:app --host 127.0.0.1 --port 8000 --reload

# å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
run-prod:
	gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

# è¿è¡Œå®Œæ•´çš„CIæ£€æŸ¥æµç¨‹
ci: clean install dev check test-cov
	@echo "âœ… æ‰€æœ‰CIæ£€æŸ¥é€šè¿‡!"

# å¿«é€Ÿå¼€å‘è®¾ç½®
quick-start: dev
	@echo "ğŸš€ å¼€å‘ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª!"
	@echo "è¿è¡Œ 'make run' å¯åŠ¨å¼€å‘æœåŠ¡å™¨"

# ç”Ÿäº§éƒ¨ç½²å‡†å¤‡
prod-ready: ci build
	@echo "ğŸ¯ ç”Ÿäº§éƒ¨ç½²åŒ…å·²å‡†å¤‡å°±ç»ª!"