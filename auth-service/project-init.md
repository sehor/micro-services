本项目旨在构建一个独立的、中央化的认证与授权微服务。该服务将利用 Supabase 作为核心的身份提供者 (Identity Provider)，并在此基础上实现对多个前端/后端应用的统一用户管理和精细化的访问授权。目标是实现认证与业务逻辑的完全解耦，提供单点登录 (SSO) 的用户体验，并提高整个系统生态的安全性与可维护性。

认证外包 (Authentication as a Service): 将用户注册、登录、密码管理、第三方登录等所有认证相关的功能全部委托给 Supabase Auth 服务处理。

+----------------+      1. 登录/注册      +-----------------+
|                | <-------------------- |                 |
|  前端应用(A, B) |                       |  Supabase Auth  |
|                | --------------------> | (身份提供者)    |
+----------------+      2. 返回 JWT       +-----------------+
       |
       | 3. API 请求，携带 JWT
       |
       |--------------------------------------->+-------------------+
       |                                        |                   |
       |       +------------------------------->|  业务应用 A       |
       |       |                                | (FastAPI/Django)  |
       |       |                                |                   |
       |       |                                +-------------------+
       |       |                                        |
       |       | 4a. JWT验证(本地) & 授权查询(DB)         |
       |       |                                        |
+------V-------V------+                                  |
|                     | <--------------------------------+
|  共享业务数据库     |
|   (PostgreSQL)      |
| - user_app_access   | <--------------------------------+
|                     |                                  |
+---------------------+                                  |
       ^       ^                                         |
       |       |                                         |
       |       | 4b. JWT验证(本地) & 授权查询(DB)          |
       |       |                                         |
       |       |                                +-------------------+
       |       |                                |                   |
       |       +------------------------------->|  业务应用 B       |
       |                                        | (FastAPI/Django)  |
       |                                        |                   |
       +--------------------------------------->+-------------------+

Supabase:
职责: 充当身份提供者 (IdP)。处理用户注册、登录、密码重置、签发 JWT。auth.users 表是唯一的用户身份信息源。
业务应用 (A, B, C...):
职责:
实现自身的核心业务逻辑。
独立进行安全验证: 每个应用都包含一个可重用的安全模块（例如，FastAPI 的依赖项或 Django 的中间件），用于执行 JWT 认证和数据库授权检查。
连接到共享业务数据库以获取授权数据。
技术栈: 可以是 FastAPI, Django 或任何其他后端框架。
共享业务数据库:
职责: 存储授权信息。所有业务应用都从此数据库读取授权规则。
技术选型: PostgreSQL (推荐使用 Supabase 项目自带的 Postgres 数据库以简化管理)。


3. 核心流程设计
(此流程与中心化验证模式完全相同)*
前端: 用户在前端应用中注册。
Supabase: 前端调用 supabase.auth.signUp()，请求直达 Supabase。
数据库触发器: 在 Supabase 的 PostgreSQL 数据库中，创建一个触发器。当新用户在 auth.users 表中被创建时，触发器自动在 user_app_access 表中为该用户创建初始的授权记录。
(此流程与中心化验证模式完全相同)*
Supabase: 前端调用 Supabase Auth 接口完成登录，并获取 JWT。
前端: 安全地存储 JWT。
前端: 向业务应用 A 的 API (/api/a/some-data) 发起请求，并在 Authorization 请求头中附加 JWT。
业务应用 A (认证):
应用 A 的中间件或装饰器捕获请求。
从请求头中提取 JWT。
使用应用 A 自身配置的环境变量 SUPABASE_JWT_SECRET 对 JWT 进行本地解码和验证。
如果验证失败，应用 A 直接返回 401 Unauthorized。
如果验证成功，从中解析出 user_id。
业务应用 A (授权):
程序继续执行，连接到共享业务数据库。
查询 user_app_access 表，确认该 user_id 对于应用 A (app_identifier = 'app_a') 的状态是否为 active。
如果授权检查失败，应用 A 直接返回 `4. 业务逻辑: 授权检查通过后，应用 A 执行其核心业务逻辑，并返回结果。

***注意，本项目只关注认证与授权的实现，不关注业务逻辑的实现。业务逻辑的实现由每个业务应用自身负责。***